import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib import font_manager as fm, rcParams
import os
import requests

# Function to download and register Sarabun font
def register_sarabun_font(save_dir="fonts"):
    font_name = "Sarabun"
    os.makedirs(save_dir, exist_ok=True)
    font_path = os.path.join(save_dir, f"{font_name}.ttf")

    if not os.path.exists(font_path):
        # Google Fonts URL for Sarabun font
        css_url = f"https://fonts.googleapis.com/css2?family={font_name.replace(' ', '+')}&display=swap"
        response = requests.get(css_url)
        if response.status_code == 200:
            ttf_url = response.text.split("url(")[1].split(")")[0].replace('"', '')
            font_data = requests.get(ttf_url).content
            with open(font_path, "wb") as f:
                f.write(font_data)
        else:
            st.warning("Could not download Sarabun font.")
            return None

    prop = fm.FontProperties(fname=font_path)
    rcParams["font.family"] = prop.get_name()
    return prop.get_name()

# Register Sarabun font for charts
sarabun_font = register_sarabun_font()

def show_chart1():
    st.title("üì¶ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏£‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£")

    # Use the registered Sarabun font for Thai text
    if sarabun_font:
        font_path = os.path.join("fonts", "Sarabun.ttf")
        prop = fm.FontProperties(fname=font_path)
        rcParams["font.family"] = prop.get_name()

    # Check if data exists in session_state
    if 'uploaded_data' in st.session_state:
        df = st.session_state['uploaded_data']

        if '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô' in df.columns and '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' in df.columns:
            # Filter the data where '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' is '‡∏£‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'
            df_filtered = df[df['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'] == '‡∏£‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£']

            # Check if there is data after filtering
            if not df_filtered.empty:
                df_filtered['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'] = pd.to_datetime(df_filtered['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'], errors='coerce')
                df_filtered = df_filtered.dropna(subset=['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'])

                # Extract month and year for grouping
                df_filtered['Year-Month'] = df_filtered['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'].dt.to_period('M')

                # Create a list of unique months for selection
                months = df_filtered['Year-Month'].unique()
                month_options = ['ALL'] + [str(month) for month in months]

                # Allow user to select a month
                selected_month = st.selectbox(
                    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                    month_options,
                    index=0  # Default to 'ALL'
                )

                # Filter data based on the selected month
                if selected_month != 'ALL':
                    df_filtered = df_filtered[df_filtered['Year-Month'] == pd.Period(selected_month)]

                # Summary data (count per date within the month)
                summary = df_filtered['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'].dt.date.value_counts().sort_index()
                summary_df = pd.DataFrame({
                    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢ Desktop Support': summary.index,
                    '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': summary.values
                })

                # Bar chart for the selected month
                if not summary_df.empty:
                    fig, ax = plt.subplots(figsize=(10, 5))
                    bars = ax.bar(summary_df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢ Desktop Support'].astype(str), summary_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'], color='skyblue')
                    ax.set_title(f'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏£‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ø - {selected_month}', fontsize=14)
                    ax.set_xlabel('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô')
                    ax.set_ylabel('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå')
                    plt.xticks(rotation=45)
                    plt.grid(axis='y', linestyle='--', alpha=0.7)

                    # Display count on top of each bar
                    for bar in bars:
                        yval = bar.get_height()
                        ax.text(bar.get_x() + bar.get_width() / 2, yval + 0.1, int(yval), ha='center', va='bottom', fontsize=10)

                    # Apply the font to the labels and ticks
                    for label in ax.get_xticklabels():
                        label.set_fontproperties(prop)
                    for label in ax.get_yticklabels():
                        label.set_fontproperties(prop)

                    st.pyplot(fig)

                    # Display the data table below the chart
                    st.subheader(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {selected_month}")
                    st.dataframe(summary_df)
                else:
                    st.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {selected_month}")
            else:
                st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏£‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'")
        else:
            st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Desktop Support ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel")
    else:
        st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Home ‡∏Å‡πà‡∏≠‡∏ô")
